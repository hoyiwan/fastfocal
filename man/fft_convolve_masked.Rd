% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fft_utils.R
\name{fft_convolve_masked}
\alias{fft_convolve_masked}
\title{Masked FFT convolution with next-fast-length padding}
\usage{
fft_convolve_masked(
  mat,
  kernel,
  fun = c("mean", "sum"),
  na.rm = TRUE,
  na.policy = c("omit", "all"),
  pad = c("none", "auto")
)
}
\arguments{
\item{mat}{Numeric matrix. Input raster values (rows × cols).}

\item{kernel}{Numeric matrix. Focal weights (UNnormalized). Any non-binary
kernel is supported; for binary footprints (e.g., circle/rectangle) this
is typically 0/1.}

\item{fun}{Character. One of \code{"mean"} or \code{"sum"}.}

\item{na.rm}{Logical. If \code{TRUE}, ignore NAs; if \code{FALSE}, require
a fully valid window (any NA in window yields NA).}

\item{na.policy}{Character. \code{"omit"} leaves NA centers as NA;
\code{"all"} fills NA centers when neighbors exist (gap-filling).}

\item{pad}{Character. \code{"none"} or \code{"auto"} (pad to next 5-smooth
sizes). \code{"auto"} stabilizes speed on awkward sizes.}
}
\value{
Numeric matrix (rows × cols) aligned with \code{mat}, transposed
at the end to match \pkg{terra} value ordering used by \code{fastfocal()}.
}
\description{
Performs 2D convolution via FFT with correct NA semantics by using a
value mask and (optionally) padding each dimension to a "5-smooth"
length (product of 2, 3, 5) for stable performance. Results are cropped
to the original raster size and oriented to match \pkg{terra} values.
}
\keyword{internal}
